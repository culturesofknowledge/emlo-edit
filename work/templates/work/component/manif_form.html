{% load static %}

<fieldset>
    <legend>Basic details</legend>
    <label>Document type:</label>
    {{ manif_form.manifestation_type }}

    <label>Repository -- TODO:</label> <!-- KTODO -->

    <label>ID number or shelfmark:</label>
    {{ manif_form.id_number_or_shelfmark }}

    <label>Or: </label>

    {{ manif_form.printed_edition_details }}
    <div class="ref-publication-row" textbox_id="{{ manif_form.printed_edition_details.id_for_label }}"></div>

</fieldset>

{% include "work/component/common_date_fields.html" with name='manifestation' date_as_marked=manif_form.manifestation_creation_date_as_marked calendar_used=manif_form.manifestation_creation_calendar is_range=manif_form.manifestation_creation_date_is_range day_field=manif_form.manifestation_creation_date_day month_field=manif_form.manifestation_creation_date_month year_field=manif_form.manifestation_creation_date_year normal_date=manif_form.manifestation_creation_date gregorian_date=manif_form.manifestation_creation_date_gregorian inferred=manif_form.manifestation_creation_date_inferred  uncertain=manif_form.manifestation_creation_date_uncertain  approx=manif_form.manifestation_creation_date_approx date_comment_formset=date_comment_formset %}


<fieldset>
    <legend>Former owners</legend>

    {% include "core/component/create_update_recref.html" with recref_type='person' recref_formset=recref_former.update_formset new_form=recref_former.new_form add_label='Add former owner:' %}

</fieldset>


<fieldset>
    <legend>Enclosures (letters and other types of enclosure)</legend>
    <span>
        Note: when entering enclosure details, please treat any work/manifestation on the Cultures of Knowledge system as a letter.
    </span>

    {% include "core/component/create_update_recref.html" with recref_type='manif' recref_formset=recref_enclosure_manif.update_formset new_form=recref_enclosure_manif.new_form add_label='Add another enclosed letter:' hide_create_btn=True no_date=True %}

    <span>OTHER TYPES of enclosure, e.g. money, books, samples of minerals:</span>
    <label> Details of enclosures other than letters </label>
    {{ manif_form.non_letter_enclosures }}

    <label> Details of attached or accompanying materials </label>
    {{ manif_form.accompaniments }}

</fieldset>


<fieldset>
    <legend>Letters in which this one was enclosed</legend>

    {% include "core/component/create_update_recref.html" with recref_type='manif' recref_formset=recref_enclosed_manif.update_formset new_form=recref_enclosed_manif.new_form add_label='Add another enclosing letter:' hide_create_btn=True no_date=True %}

</fieldset>

<fieldset>
    <legend> Paper and markings:</legend>

    <label>Letter opened:</label>
    {{ manif_form.opened }}

    <label>Paper size:</label>
    {{ manif_form.paper_size }}
    <span>(up to 500 characters)</span>


    <label>Stored folded:</label>
    {{ manif_form.stored_folded }}

    <label>Paper type, watermark:</label>
    {{ manif_form.paper_type_or_watermark }}
    <span>(up to 500 characters)</span>

    <label>Number of pages:</label>
    {{ manif_form.number_of_pages_of_document }}
    <span>(whole numbers only)</span>

    <label>Seal:</label>
    {{ manif_form.seal }}

    <label>Postage marks:</label>
    {{ manif_form.postage_marks }}

    <label>Postage costs as marked:</label>
    {{ manif_form.postage_costs_as_marked }}

    <label>Postage cost(s):</label>
    {{ manif_form.postage_costs }}

    <label>Address:</label>
    {{ manif_form.address }}

    <label>Routing Mark (stamp):</label>
    {{ manif_form.routing_mark_stamp }}

    <label>Routing Mark (MS):</label>
    {{ manif_form.routing_mark_ms }}

    <label>Handling Instructions:</label>
    {{ manif_form.handling_instructions }}

    <label>Other endorsements:</label>
    {{ manif_form.endorsements }}

    <label>Reason for non-delivery:</label>
    {{ manif_form.non_delivery_reason }}


</fieldset>

{% include "work/component/common_date_fields.html" with name='receipt' date_as_marked=manif_form.date_of_receipt_as_marked calendar_used=manif_form.manifestation_receipt_calendar is_range=manif_form.manifestation_receipt_date_is_range day_field=manif_form.manifestation_receipt_date_day month_field=manif_form.manifestation_receipt_date_month year_field=manif_form.manifestation_receipt_date_year normal_date=manif_form.manifestation_receipt_date gregorian_date=manif_form.manifestation_receipt_date_gregorian inferred=manif_form.manifestation_receipt_date_inferred  uncertain=manif_form.manifestation_receipt_date_uncertain  approx=manif_form.manifestation_receipt_date_approx date_comment_formset=receipt_date_comment_formset %}

<fieldset>
    <legend>Language of manifestation:</legend>
    {{ manif_form.manifestation_is_translation }}
    <label for="{{ manif_form.manifestation_is_translation.id_for_label }}"> Manifestation is translation </label>
    <small>
        (It is not necessary to enter language, incipit and explicit of manifestation if they are the same as those of
        the original work.)
        <br />
        If a language you require is not displayed below, you can add it to the list: Add further possible languages

        <br />
        <br />
        If the languages you want are already displayed below, tick one or more checkboxes to select as many as
        required, then click Save. You can also enter very brief notes on the selected languages using the input fields
        below each checkbox, for example if you wanted to specify that a text is mainly in one language but there are
        just a few words in another language.
    </small>


    {{ edit_lang_formset.management_form }}
    {% for form in edit_lang_formset %}
        <label>{{ form.lang_name.value }}  </label>
        {{ form.lang_name }}
        {{ form.notes }}
        {{ form.lang_rec_id }}
        {{ form.is_del }}
        <label for="{{ form.is_del.id_for_label }}">delete?</label>
    {% endfor %}


    <div class="lang_div" formset_name="new_lang">
        <label>New Language:</label>
        {{ manif_form.new_language }}
        {{ manif_form.language_list }}
        <button class="lang_add_btn">+</button>
        <div class="old_lang_div"></div>
        <div class="new_lang_div"></div>
    </div>
</fieldset>

<fieldset>
    <legend>Incipit and explicit:</legend>

    <label>Manifestation incipit</label>
    {{ manif_form.manifestation_incipit  }}

    <label>Manifestation explicit</label>
    {{ manif_form.manifestation_excipit   }}

</fieldset>


<fieldset>
    <legend> Notes on manifestation </legend>

</fieldset>

<script>
    function on_lang_del_click(e) {
        e.preventDefault();
        $(e.target.parentElement).remove();
    }

    function get_next_lang_idx(new_lang_div_jqe) {
        if (new_lang_div_jqe.children().length == 0) {
            return 1;
        }
        let ids = new_lang_div_jqe.find('input[name][type=text]').map(function () {
            let _name = $(this).attr('name')
            let _idx = /.+?-(\d+)/.exec(_name)[1]
            return parseInt(_idx)
        }).get()
        return Math.max(...ids) + 1
    }

    function setup_add_lang() {
        $('.lang_add_btn').on('click', function (e) {
            e.preventDefault();
            let lang_div_jqe = $(e.target.parentElement);
            let selected_lang_jqe = lang_div_jqe.find('input[type=text]');
            let selected_lang = selected_lang_jqe.val()
            if (!selected_lang) {
                return
            }
            // let formset_name = lang_div_jqe.attr('formset_name')
            // let lang_idx = get_next_lang_idx(lang_div_jqe.find('.new_lang_div'))

            let new_lang_div = lang_div_jqe.find('.new_lang_div');
            let new_lang = $('<div class="row-no-margin"></div>')
            new_lang.append(`<label>${selected_lang}</label>`)
            new_lang.append(`<input name="lang_name" type="hidden" value="${selected_lang}" />`)
            new_lang.append(`<input name="lang_note" type="text" />`)
            // new_lang.append(`<input name="${formset_name}-${lang_idx}-lang_name" type="hidden" // value="${selected_lang}" />`)
            // new_lang.append(`<input name="${formset_name}-${lang_idx}-note" type="text" />`)
            let del_btn_jqe = $('<button class="lang_del_btn">Del</button>')
            del_btn_jqe.on('click', on_lang_del_click)
            new_lang.append(del_btn_jqe)

            new_lang_div.append(new_lang)
            selected_lang_jqe.val('')
        })
        $('.lang_del_btn').on('click', on_lang_del_click)

    }

    $(function () {
        setup_add_lang()
    });

</script>

<script src="{% static 'core/js/auto_date_calendar.js' %}" defer></script>
<script>
    $(function () {
        new AutoCalendar(
            '#id_manifestation_creation_date_year',
            '#id_manifestation_creation_date_month',
            '#id_manifestation_creation_date_day',
            'input[name=manifestation_creation_calendar]',
            '#id_manifestation_creation_date',
            '#id_manifestation_creation_date_gregorian',
        ).setup_auto_calendar();

        new AutoCalendar(
            '#id_manifestation_receipt_date_year',
            '#id_manifestation_receipt_date_month',
            '#id_manifestation_receipt_date_day',
            'input[name=manifestation_receipt_calendar]',
            '#id_manifestation_receipt_date',
            '#id_manifestation_receipt_date_gregorian',
        ).setup_auto_calendar();
    })
</script>
