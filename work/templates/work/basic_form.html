{% extends "core/emlo_logined.html" %}
{% load static %}

{% block head %}
    <script src="/static/core/js/recref_service.js"></script>
    <script src="{% static 'core/js/ref_publication_service.js' %}" defer></script>
    <script src="{% static 'core/js/table_of_content_service.js' %}" defer></script>
    <script src="{% static 'core/js/selectfilter.js' %}" defer></script>
    <script>

        var emlojs = emlojs || {};
        emlojs.leave_warning = {
            is_submit: false,
            setup_leave_warning: function () {
                function load_input_map() {
                    let input_map = new Map();
                    for (let ele of document.querySelectorAll('input[name],textarea[name],select[name]')) {
                        if (['checkbox', 'radio'].includes(ele.type)) {
                            input_map.set(ele.name, ele.checked);
                        } else {
                            input_map.set(ele.name, ele.value);
                        }
                    }
                    return input_map
                }

                function compare_map(map_old, map_new) {
                    let diff_map = new Map();
                    for (let [key, new_val] of map_new) {
                        let old_val = map_old.get(key);
                        if (old_val !== new_val) {
                            diff_map.set(key, [old_val, new_val])
                        }
                    }
                    return diff_map
                }

                // event beforeunload
                const org_input_map = load_input_map()
                window.addEventListener('beforeunload', function (e) {
                    if (emlojs.leave_warning.is_submit) {
                        return
                    }
                    const new_input_map = load_input_map();
                    const diff_map = compare_map(org_input_map, new_input_map);
                    if (diff_map.size) {
                        console.log('diff_map changed:')
                        console.log(diff_map)
                        e.preventDefault()
                        e.returnValue = 'Changes that you made may not be saved.'
                    }
                });

                // event submit
                $('form').on('submit', function (event) {
                    emlojs.leave_warning.is_submit = true;
                });
            },
        }


        $(function () {
            setup_table_of_content();
            setup_selectfilter();
            $('.catalogue-div .selectfilter-root').on('select-changed', function (e, selected_text, selected_val) {
                document.querySelector('#id_catalogue').value = selected_val;
            });
            $('.sf-select').mousedown(function (e) {
                e.preventDefault()
                this.blur()
            });

            emlojs.leave_warning.setup_leave_warning();

        });
    </script>
{% endblock %}

{% block content %}

    <div class="form-core-div">
        <div class="form-col-left toc-host"></div>
        <div class="form-col-right">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {% include "core/component/form_descriptor.html" with descriptor=form_descriptor %}

                <label>Original catalogue:</label>
                <div class="catalogue-div">
                    {% include "core/component/selectfilter.html" with select_field=catalogue_form.catalogue  datalist_field=catalogue_form.catalogue_list %}
                </div>

                <div class="row-no-margin">
                    {% include "work/component/tab_link.html" with name='Correspondents' vname='work:corr_form' iwork_id=iwork_id %}
                    {% include "work/component/tab_link.html" with name='Dates' vname='work:dates_form' iwork_id=iwork_id %}
                    {% include "work/component/tab_link.html" with name='Places' vname='work:places_form' iwork_id=iwork_id %}
                    {% if iwork_id %}
                        {% include "work/component/tab_link.html" with name='Manifestation' vname='work:manif_init' iwork_id=iwork_id %}
                    {% endif %}
                    {% if iwork_id %}
                        {% include "work/component/tab_link.html" with name='Resources' vname='work:resources_form' iwork_id=iwork_id %}
                    {% endif %}
                    {% include "work/component/tab_link.html" with name='Other Details' vname='work:details_form' iwork_id=iwork_id %}
                    {% if iwork_id %}
                        {% include "work/component/tab_link.html" with name='Overview' vname='work:overview_form' iwork_id=iwork_id %}
                    {% endif %}
                </div>


                <div class="tab-content tc-corr">  <!-- KTODO remove class -->
                    {% block tabcontent %}
                    {% endblock %}
                </div>


                {% include "core/component/actionbox.html" %}

            </form>


        </div>
    </div>





{% endblock %}
